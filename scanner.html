<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan QR Code - HealthLock</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/style.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-lg bg-white rounded-xl shadow-2xl p-8 text-center relative">
        <a href="/" title="Go back" class="absolute top-4 left-4 text-gray-400 hover:text-indigo-600 transition-colors">
            <i class="fas fa-arrow-left text-2xl"></i>
        </a>
        
        <a href="/" class="text-3xl font-bold text-indigo-600">
            <i class="fas fa-shield-heart mr-2"></i>HealthLock
        </a>
        <h1 class="text-2xl font-bold text-gray-800 mt-4">Scan a Record's QR Code</h1>
        <p class="text-gray-500 mt-2">Upload an image of a HealthLock QR code to securely download the shared file.</p>

        <div id="qr-file-uploader" class="mt-6">
            <label for="qr-input-file" class="w-full flex items-center justify-center px-4 py-6 bg-gray-50 text-indigo-600 rounded-lg shadow-md tracking-wide uppercase border border-indigo-600 cursor-pointer hover:bg-indigo-600 hover:text-white">
                <i class="fas fa-image text-2xl mr-3"></i>
                <span class="text-base leading-normal">Select a QR Code Image</span>
                <input type='file' id="qr-input-file" class="hidden" accept="image/*" />
            </label>
        </div>
        
        <div id="qr-reader-result" class="mt-4 text-lg font-semibold"></div>
    </div>

    <script>
        const qrInputFile = document.getElementById("qr-input-file");
        const resultContainer = document.getElementById('qr-reader-result');

        // Function to handle successful scan
        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Code matched = ${decodedText}`, decodedResult);
            resultContainer.innerHTML = `
                <p class="text-green-600">Scan successful!</p>
                <p class="text-gray-600 text-sm">Redirecting to download...</p>
            `;
            // Redirect to the download link
            window.location.href = decodedText;
        }

        // Function to handle scan failure
        function onScanFailure(error) {
            console.warn(`Code scan error = ${error}`);
            resultContainer.innerHTML = `<p class="text-red-500">Could not decode QR code from the selected image. Please try another file.</p>`;
        }

        // Create a new scanner instance. The first argument is the ID of the element to render the scanner to, but we don't need it for file-based scanning.
        const html5QrCode = new Html5Qrcode("qr-reader-result");

        // Add event listener to the file input
        qrInputFile.addEventListener('change', e => {
            if (e.target.files.length == 0) {
                return;
            }
            const imageFile = e.target.files[0];
            
            resultContainer.innerHTML = `<p class="text-gray-600 text-sm">Scanning...</p>`;

            // Scan the selected image file
            html5QrCode.scanFile(imageFile, true)
            .then(decodedText => {
                onScanSuccess(decodedText);
            })
            .catch(err => {
                onScanFailure(err);
            });
        });
    </script>

</body>
</html>